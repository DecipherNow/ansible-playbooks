- name: Create service group if it doesnt exist
  group:
    name: "{{ service_group }}"
    state: present
    system: yes
  tags: incert
  
- name: Creating service user if it doesnt exist
  user:
    name: "{{ service_user }}"
    groups: "{{ service_group }}"
    system: yes
    append: yes
  tags: incert

- name: Create certs directory
  file:
    path: "{{ certs_directory }}"
    state: directory
    mode: u=rwx,g=rx,o=rx
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    recurse: yes
  tags: incert

- name: Add incert binary
  copy:
    src: incert
    dest: /usr/local/bin
    owner: "{{ service_user }}"
    group: "{{ service_group }}"
    mode: u=rwx,g=rx,o=rx
  tags: incert

- name: Check if the localhost certs where created within 4 days
  shell: |
    find "{{ certs_directory }}" -type f -newermt $(date '+%Y-%m-%d' --date="4 days ago") ! -newermt $(date '+%Y-%m-%d') | grep localhost
  register: cert_result
  tags: incert

- name: Create localhost certificates
  shell: |
    /usr/local/bin/incert issue single -c localhost -e 432000s -d /tmp/certs_dir
  when: cert_result.rc == 1
  tags: incert
    