---

- name: Create task definition dashboard
  ecs_taskdefinition:
    state: present
    family: "greymatter-dashboard"
    network_mode: "host"
    launch_type: "EC2"
    execution_role_arn: "arn:aws:iam::151736245382:role/ecsInstanceRole"
    task_role_arn: "arn:aws:iam::151736245382:role/ecsInstanceRole"
    # volumes:
    #   - name: certs
    #     host:
    #       sourcePath: "/home/ec2-user/pki"
    containers:
      # todo: add sidecar
      - name: dashboard
        cpu: 256
        essential: true
        image: "docker-greymatter.di2e.net/greymatter/gm-dashboard:3.1.0"
        repositoryCredentials:
          credentialsParameter: "arn:aws:secretsmanager:us-east-2:151736245382:secret:ecs-greymatter/zGREYMATTER-ci-6WOFGP"
        memory: 400
        dockerLabels:
          gm-cluster: "service-dashboard"
        environment:
          - name: "BASE_PATH"
            value: "/"
          - name: "FABRIC_SERVER"
            value: "/services/catalog/1.0"
          - name: "CONFIG_SERVER"
            value: "/services/control-api/1.0/v1.0"
          - name: "OBJECTIVES_SERVER"
            value: "/services/slo/latest"
          # - name: "USE_PROMETHEUS"
          #   value: "true"
          # - name: "PROMETHEUS_SERVER"
          #   value: "/services/prometheus/api/v1/"
          # - name: "ENABLE_SENSE"
          #   value: "true"
          # - name: "SENSE_SERVER"
          #   value: "/services/sense/1.0"
        portMappings:
          - containerPort: 1337
            hostPort: 1337
            protocol: tcp
        logConfiguration:
          logDriver: awslogs
          options:
            awslogs-group: openjobs
            awslogs-region: us-east-2
            awslogs-stream-prefix: web
  register: task_output

- name: ECS service
  ecs_service:
    state: present
    name: dashboard
    cluster: "greymatter-ecs-cluster"
      task_definition: "{{  task_output.taskdefinition[\"family\"]   }}:{{ task_output.taskdefinition[\"revision\"] }}"
    desired_count: 1
    # todo: load balance service/sidecar pairs -- each instance is a sidecar->service
    load_balancers:
      - targetGroupArn: "arn:aws:elasticloadbalancing:us-east-2:151736245382:targetgroup/greymatter-ecs-alb-target-group2/6a3fddf3a004d6fe"
        containerName: "proxy-dashboard"
        containerPort: "8080"
  register: "ecs_service"
