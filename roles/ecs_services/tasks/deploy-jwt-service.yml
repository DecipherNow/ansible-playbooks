---

  - name: Create task definition jwt
    ecs_taskdefinition:
      state: present
      family: "greymatter-jwt"
      network_mode: awsvpc
      launch_type: FARGATE
      cpu: 512
      memory: 1024
      region: "us-east-1"
      execution_role_arn: "arn:aws:iam::706634194319:role/ecsInstanceRole"
      task_role_arn: "arn:aws:iam::706634194319:role/ecsInstanceRole"
      volumes:
      - name: certs
        host:
          sourcePath: "/home/ec2-user/pki"
      containers:
      - name: "proxy-jwt"
        essential: true
        image: "docker-greymatter.di2e.net/greymatter/gm-proxy:0.8.1"
        repositoryCredentials:
          credentialsParameter: "arn:aws:secretsmanager:us-east-2:151736245382:secret:ecs-greymatter/zGREYMATTER-ci-6WOFGP"
        dockerLabels:
          gm-cluster: "sidecar-jwt"
        environment:
        - name: "ENVOY_ADMIN_LOG_PATH"
          value: "/dev/stdout"
        - name: "PROXY_DYNAMIC"
          value: true
        - name: "XDS_CLUSTER"
          value: jwt
        - name: "XDS_HOST"
          value: "localhost" # todo point to gm-control
        - name: "XDS_PORT"
          value: 50000
        - name: "XDS_NODE_ID"
          value: "default-node"
        portMappings:
        - containerPort: 9080
          hostPort: 9080
          protocol: tcp
        - containerPort: 8081
          hostPort: 8081
          protocol: tcp
        mountPoints:
        - containerPath: "/etc/proxy/tls/sidecar"
          sourceVolume: "certs"
        logConfiguration:
          logDriver: awslogs
          options:
            awslogs-group: openjobs
            awslogs-region: us-east-2
            awslogs-stream-prefix: web
      - name: jwt
        essential: true
        image: "docker-greymatter.di2e.net/greymatter/gm-jwt-security:0.2.0"
        repositoryCredentials:
          credentialsParameter: "arn:aws:secretsmanager:us-east-2:151736245382:secret:ecs-greymatter/zGREYMATTER-ci-6WOFGP"
        dockerLabels:
          gm-cluster: "service-jwt"
        environment:
        # - name: KAFKA_PEERS
        #   value: "kafka-0.kafka.kafka.svc.cluster.local:9092,kafka-1.kafka.kafka.svc.cluster.local:9092,kafka-2.kafka.kafka.svc.cluster.local:9092"
        - name: "HTTP_PORT"
          value: 8080
        - name: "USERS_JSON"
          value: "{{ lookup('file', 'jwt-users.json') }}"
        - name: "PRIVATE_KEY"
          value: "{{ lookup('aws_secret', 'jwt-private-key') }}"
        - name: "TOKEN_EXP_TIME"
        - name: "REDIS_HOST"
          value: localhost
        - name: "REDIS_PORT"
          value: 6379
        - name: "REDIS_DB"
          value: 1
        - name: "REDIS_PASS"
          value: "{{ lookup('aws_secret', 'redis-password') }}"
        - name: "JWT_API_KEY"
          value: "{{ lookup('aws_secret', 'data-jwt-api-key') }}"
        - name: "ENABLE_TLS"
          value: false
        - name: "DEFAULT_PATH"
          value: "/services/"
        portMappings:
        - containerPort: 8080
          hostPort: 8080
          protocol: tcp
        logConfiguration:
          logDriver: awslogs
          options:
            awslogs-group: openjobs
            awslogs-region: us-east-2
            awslogs-stream-prefix: web
      - name: redis
        cpu: 256
        essential: true
        image: "docker.io/centos/redis-32-centos7"
        repositoryCredentials:
          credentialsParameter: "arn:aws:secretsmanager:us-east-2:151736245382:secret:ecs-greymatter/zGREYMATTER-ci-6WOFGP"
        memory: 400
        environment:
        - name: "REDIS_PASSWORD"
          value: "{{ lookup('aws_secret', 'redis-password') }}"
        portMappings:
        - containerPort: 6379
          hostPort: 6379
        logConfiguration:
          logDriver: awslogs
          options:
            awslogs-group: openjobs
            awslogs-region: us-east-2
            awslogs-stream-prefix: web
    register: task_output

  - name: ECS service
    ecs_service:
      state: present
      name: jwt
      cluster: "greymatter-ecs-cluster"
      region: "us-east-1"
      launch_type: FARGATE
      task_definition: "{{  task_output.taskdefinition[\"family\"]   }}:{{ task_output.taskdefinition[\"revision\"] }}"
      desired_count: 1
      network_configuration:
        assign_public_ip: true
        security_groups:
        - "sg-058ff37fcba82d64e"
        subnets:
        - "subnet-0e06fb4f956d9f5f8"
        - "subnet-0a0d8c7178470ccfd"
        - "subnet-04b7db2914fabe8e3"
      load_balancers:
        - targetGroupArn: "arn:aws:elasticloadbalancing:us-east-1:706634194319:targetgroup/greymatter-ecs-alb-tg-ip/826faf9b835b9140"
          containerName: "proxy-jwt"
          containerPort: 9080
    register: "ecs_service"
